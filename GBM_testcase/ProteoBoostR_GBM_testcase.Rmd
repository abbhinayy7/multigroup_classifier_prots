### ProteoBoostR ###

#Application example: Learning subtypes in GBM

#libraries
```{r}
library(tidyverse)
library(readxl)
library(limma)
library(xgboost)
library(ggalluvial)
```

#load data
```{r}
#Werner et al 
Werner_data <- read.table("Werner_data.tsv", header = TRUE)

Werner_annot <- read.table("Werner_annot.tsv", header = TRUE)

#CPTAC
CPTAC_data <- read.table("CPTAC_data.tsv", header = TRUE)

CPTAC_annot <- read.table("CPTAC_annot.tsv", header = TRUE)
```

#differential abundance analysis
```{r}
#sparsity reduction
Werner_data_fil <- Werner_data %>%
  filter(rowSums(is.na(.)) / ncol(.) <= 0.5)

subtypes <- Werner_annot$subtypes

design <- model.matrix(~0+subtypes)

row.names(design) <- colnames(Werner_data_fil)
colnames(design) <- c("One", "Rest")

#define contrasts
contrast.matrix <- makeContrasts(OnevsRest = One-Rest,
                                 levels = design)

n_contrasts <- dim(contrast.matrix)[2]

#run limma
fit <- lmFit(Werner_data_fil, 
             design = design,
             method = "ls")

fit2 <- contrasts.fit(fit, 
                      contrast.matrix)

fit2 <- eBayes(fit2)

limma_subtypes <- topTable(fit2, adjust.method = "BH", number = Inf)

limma_subtypes$Protein.Group <- row.names(limma_subtypes)

#volcano plot
limma_subtypes <- limma_subtypes %>%
  mutate(Differentially_expressed = case_when(adj.P.Val <= 0.05 ~ TRUE, TRUE ~ FALSE)) 

limma_subtypes <- limma_subtypes %>%
  mutate(col = case_when(Differentially_expressed == TRUE & logFC < 0 ~ "other", 
                         Differentially_expressed == TRUE & logFC > 0 ~ "neuronal",
                         Differentially_expressed == FALSE ~ "none")) 

limma_subtypes$Differentially_expressed <- as.character(limma_subtypes$Differentially_expressed)

ggplot(data = limma_subtypes, 
       mapping = aes(x = logFC,
                     y = -log10(adj.P.Val),
                     color = col)) + 
  geom_point(size = 0.2) + 
  geom_hline(yintercept = -log10(0.05), linetype = "dashed", color = "gray20", size = 0.5) +
  labs(y = "-Log10 (adj. p-value)", x = "Log2 FC") + 
  scale_y_continuous(limits = c(0, 20), breaks = c(0, 10, 20)) +
  theme(
        axis.text = element_text(size = 8, color = "black"),
        axis.title.x = element_text(size = 8, color = "black", face = "bold", margin = margin(t = 0)),
        axis.title.y = element_text(size = 8, color = "black", face = "bold", margin = margin(r = 0)),
        strip.text = element_text(size = 8, color = "black", face = "bold"),
        strip.background = element_rect(fill = "white"),
        legend.text = element_text(size = 8, color = "black"),
        legend.title = element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_rect(colour = "black", 
                                    fill = NA, 
                                    linewidth = 0.8),
        legend.spacing.y = unit(0.5, "cm"),
        legend.position = "none") +
  scale_color_manual(values = c("neuronal" = "#4eb3d3", "other" = "#feb24c", "FALSE" = "grey20"))

features_up <- limma_subtypes %>%
  filter(col == "neuronal") %>%
  arrange(-logFC) %>%
  head(10)
features_down <- limma_subtypes %>%
  filter(col == "other") %>%
  arrange(logFC) %>%
  head(10)
features <- c(features_up$Protein.Group, features_down$Protein.Group)

write.table(features, file = "features.tsv", 
            quote = FALSE,      # no quotes around strings
            row.names = FALSE,  # no row numbers
            col.names = FALSE,  # no column header
            sep = "\t")         # tab-separated
```

#run ProteoBoostR
```{r}
#install ProteoBoostR

#train model on Werner data
#subtype 1 as positive class, subtype2+3+4 as negative class
#use subset of features
#use a train/test split of 0.7
#use the default parameter bounds

#apply model on CPTAC data
#nmf1 as positive class, nmf2/nmf3 as negative class
#range around threshold: 0.1
```

#visualize performance
```{r}
#load predicted class probabilities and classification threshold
preds <- read_tsv("ProteoBoostR_output\\predicted_probabilities_20251113095149_adhoc1.tsv")
eval_res <- read_tsv("ProteoBoostR_output\\evaluation_results_20251113095149_adhoc1.tsv")
threshold <- eval_res$Applied_Threshold

preds <- left_join(preds, CPTAC_annot)

#exclude sample with probabilities of +- 0.1 around threshold
preds <- preds %>%
  filter(predicted_probability > threshold+0.1 | predicted_probability < threshold-0.1)

preds <- preds %>%
  mutate(pred_label = case_when(predicted_probability > threshold ~ "Neuronal",
                                predicted_probability < threshold ~ "Other"))

preds <- preds %>%
  mutate(Freq = rep(1, nrow(preds)))

preds$pred_label <- factor(preds$pred_label, levels = c("Other", "Neuronal"))

preds$multiomic_splitted <- factor(preds$multiomic_splitted, levels = c("nmf3", "nmf2", "nmf1"))

ggplot(preds,
       aes(y =  Freq, axis1 = pred_label, axis2 = multiomic_splitted)) +
  geom_alluvium(aes(fill = pred_label), width = 1/8, alpha = 1) +
  geom_stratum(width = 1/8) +
  geom_label(stat = "stratum", aes(label = after_stat(stratum)), label.size = 0, size = 1.9, angle = 90) +
  scale_x_discrete(limits = c("ProteoBoostR", "CPTAC"), expand = c(.05, .05)) +
  scale_y_continuous(breaks = c(0,40,80)) + 
  labs(y = "Frequency", x = "Subtype ") +
  theme_gray() +
  theme(
        axis.text = element_text(size = 8, color = "black"),
        axis.title.x = element_text(size = 8, color = "black", face = "bold", margin = margin(t = 0)),
        axis.title.y = element_text(size = 8, color = "black", face = "bold", margin = margin(r = 0)),
        strip.text = element_text(size = 8, color = "black", face = "bold"),
        strip.background = element_rect(fill = "white"),
        legend.text = element_text(size = 8, color = "black"),
        legend.title = element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_rect(colour = "black", 
                                    fill = NA, 
                                    linewidth = 0.8),
        legend.spacing.y = unit(0.5, "cm"),
        legend.position = "none") +
  scale_fill_manual(values = c("Other" = "#feb24c", "Neuronal" = "#4eb3d3"))
ggsave("CPTAC_subtypes_alluvial.png", units = "cm", width = 6, height = 3.65)
```
